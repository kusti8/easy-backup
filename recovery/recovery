#!/bin/bash

set -e

sleep 20 # Wait till everything is finished
fdisk /dev/mmcblk0 <<EOF
d # Delete the first partition
n # Create a new partition for boot
p # A primary partition temporarily
1
8192
+68M
t # Set the type
c
n
p
2


w # Write it all
EOF
echo y | mkfs.fat -F 32 /dev/mmcblk0p1
echo y | mkfs.ext4 /dev/mmcblk0p2

/bin/mount /dev/mmcblk0p2 /mnt
mkdir /mnt/boot
/bin/mount -o umask=000 /dev/mmcblk0p1 /mnt/boot
clear
echo "!!!Waiting 20 seconds for USB disk...!!!"
sleep 20
/bin/mount /dev/sda1 /root

tar xpvf --one-file-system /root/boot.tar.xz -C /mnt/boot/
tar xpvf --one-file-system /root/root.tar.xz -C /mnt/

umount /mnt/boot
umount /mnt
umount /root

clear
echo "ALL DONE! PULL THE POWER AND BOOT AGAIN!"
